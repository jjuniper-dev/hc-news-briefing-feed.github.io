name: Daily RSS Feed Health Check

on:
  schedule:
    # Runs daily at 6:00 AM Eastern (10:00 UTC)
    - cron: '0 10 * * *'
  workflow_dispatch:

jobs:
  health-check:
    name: Ping & report RSS feeds
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repo
        uses: actions/checkout@v4

      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 📦 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install feedparser requests

      - name: 🔗 Run feed health check
        id: health
        run: |
          python - << 'EOF'
import json, feedparser, requests

feeds = {
  "CBC Top Stories": "https://rss.cbc.ca/lineup/topstories.xml",
  "CTV Canada":      "https://www.ctvnews.ca/rss/ctvnews-ca-canada-1.2089050",
  "NPR US":          "https://feeds.npr.org/1001/rss.xml",
  "Reuters World":   "https://feeds.reuters.com/Reuters/worldNews",
  "BBC World":       "http://feeds.bbci.co.uk/news/world/rss.xml",
}

results = {}
for name, url in feeds.items():
    try:
        r = requests.get(url, timeout=10)
        r.raise_for_status()
        cnt = len(feedparser.parse(r.content).entries)
        results[name] = f"{cnt} items" if cnt else "ZERO"
    except Exception as e:
        results[name] = f"ERROR: {type(e).__name__}"

print("feed_status<<EOF")
print(json.dumps(results))
print("EOF")
EOF

      - name: ❌ Fail on any error/zero
        if: ${{ contains(steps.health.outputs.feed_status, 'ERROR') || contains(steps.health.outputs.feed_status, 'ZERO') }}
        run: |
          echo "One or more feeds failed health checks:"
          echo "${{ steps.health.outputs.feed_status }}"
          exit 1

      - name: ✅ All feeds healthy
        if: ${{ !contains(steps.health.outputs.feed_status, 'ERROR') && !contains(steps.health.outputs.feed_status, 'ZERO') }}
        run: echo "All feeds are healthy: ${{ steps.health.outputs.feed_status }}"