name: Daily Canadian Feed Health Check

on:
  schedule:
    # 6:00 AM Eastern (10:00 UTC)
    - cron: '0 10 * * *'
  workflow_dispatch:

jobs:
  ping-canadian-feeds:
    runs-on: ubuntu-latest
    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install deps
        run: pip install feedparser requests

      - name: Health-check CBC & CTV
        id: health
        run: |
          python - << 'EOF'
          import feedparser, requests

          feeds = {
            "CBC Top Stories": "https://rss.cbc.ca/lineup/topstories.xml",
            "CTV Canada":      "https://www.ctvnews.ca/rss/ctvnews-ca-canada-1.2089050"
          }

          results = {}
          for name, url in feeds.items():
              status = "OK"
              try:
                  r = requests.get(url, timeout=15); r.raise_for_status()
                  feed = feedparser.parse(r.content)
                  if not feed.entries:
                      status = "ZERO"
                  else:
                      status = f"{len(feed.entries)} items"
              except Exception as e:
                  status = f"ERROR: {e.__class__.__name__}"
              print(f"{name}: {status}")
              results[name] = status

          # Export summary to next steps
          import json, os
          os.environ["FEED_STATUS"] = json.dumps(results)
          EOF

      - name: Notify if any bad
        if: always()
        run: |
          echo "Feed health summary: ${{ env.FEED_STATUS }}"
          # Here you could add a curl to Slack or email the JSON