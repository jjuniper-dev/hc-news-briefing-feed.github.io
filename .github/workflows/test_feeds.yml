name: Daily Canadian Feed Health Check

on:
  schedule:
    - cron: '0 10 * * *'  # 6:00 AM ET / 10:00 UTC
  workflow_dispatch:

jobs:
  ping-canadian-feeds:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install Python dependencies
        run: pip install feedparser requests

      - name: Test Canadian feeds
        id: health
        run: |
          python3 - << 'EOF'
          import sys, feedparser, requests
          feeds = {
            "CBC Top Stories": "https://rss.cbc.ca/lineup/topstories.xml",
            "CTV Canada": "https://www.ctvnews.ca/rss/ctvnews-ca-canada-1.2089050"
          }
          failed = []
          for name, url in feeds.items():
              try:
                  r = requests.get(url, timeout=20)
                  r.raise_for_status()
                  feed = feedparser.parse(r.content)
                  if not feed.entries:
                      print(f"âŒ {name}: 0 entries")
                      failed.append(name)
                  else:
                      print(f"âœ”ï¸ {name}: {len(feed.entries)} entries")
              except Exception as e:
                  print(f"âŒ {name}: ERROR â†’ {type(e).__name__}")
                  failed.append(name)
          if failed:
              sys.exit(1)
          EOF

      - name: Notify on failure via email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          secure: true
          from: "RSS Health Bot <spatialsensation@gmail.com>"
          to: spatialsensation@gmail.com
          subject: "ðŸ”´ Canadian RSS Feeds Failure â€“ Run ${{ github.run_id }}"
          body: |
            One or more Canadian RSS feeds failed health checks.
            See the Actions log here: ${{ github.run_url }}