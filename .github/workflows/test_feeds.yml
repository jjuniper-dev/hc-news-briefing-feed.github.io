steps:
  - name: Check out repository
    uses: actions/checkout@v4

  - name: Set up Python
    uses: actions/setup-python@v5
    with:
      python-version: '3.x'

  - name: Install dependencies
    run: |
      python -m pip install --upgrade pip
      pip install feedparser requests

  - name: Test Canadian feeds
    id: test_canada
    run: |
      python - << 'EOF'
      import sys, feedparser, requests, json

      # fallback feeds list
      feeds = {
        "CBC Top Stories": [
          "https://rss.cbc.ca/lineup/topstories.xml",
          "https://www.cbc.ca/cmlink/rss-canada"
        ],
        "CTV Canada": [
          "https://www.ctvnews.ca/rss/ctvnews-ca-canada-1.2089050",
          "https://www.ctvnews.ca/rss/ctvnews-ca-top-stories-public-rss-1.2170494"
        ]
      }

      results = {}
      for name, urls in feeds.items():
          success = False
          for url in urls:
              try:
                  r = requests.get(url, timeout=10)
                  r.raise_for_status()
                  feed = feedparser.parse(r.content)
                  if feed.entries:
                      results[name] = f"{len(feed.entries)} items from {url}"
                      success = True
                      break
              except Exception as e:
                  continue
          if not success:
              results[name] = "ERROR"
      print(json.dumps(results))
      EOF
      
  - name: Report results
    run: |
      echo "Canada Feed Status: ${{ steps.test_canada.outputs.result }}"
      
  - name: Fail on errors
    run: |
      echo '${{ steps.test_canada.outputs.result }}' | grep -q 'ERROR' && exit 1 || exit 0

  - name: Notify on failure
    if: failure()
    uses: dawidd6/action-send-mail@v3
    with:
      server_address: smtp.gmail.com
      server_port: 465
      username: ${{ secrets.SMTP_USERNAME }}
      password: ${{ secrets.SMTP_PASSWORD }}
      secure: true
      from: "RSS Health Bot <spatialsensation@gmail.com>"
      to: spatialsensation@gmail.com
      subject: "ðŸ”´ RSS Feed Health Failure"
      body: "One or more Canadian feeds failed health checks: ${{ steps.test_canada.outputs.result }}"